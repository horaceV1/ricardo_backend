<?php

/**
 * @file
 * User Profile Manager module.
 */

use Drupal\Core\Entity\EntityInterface;

/**
 * Implements hook_ENTITY_TYPE_insert() for dynamic_form_submission.
 */
function user_profile_manager_dynamic_form_submission_insert(EntityInterface $entity) {
  try {
    user_profile_manager_process_submission($entity);
  }
  catch (\Exception $e) {
    \Drupal::logger('user_profile_manager')->error('Error processing submission insert: @message', ['@message' => $e->getMessage()]);
  }
}

/**
 * Implements hook_ENTITY_TYPE_update() for dynamic_form_submission.
 */
function user_profile_manager_dynamic_form_submission_update(EntityInterface $entity) {
  try {
    user_profile_manager_process_submission($entity);
  }
  catch (\Exception $e) {
    \Drupal::logger('user_profile_manager')->error('Error processing submission update: @message', ['@message' => $e->getMessage()]);
  }
}

/**
 * Process form submission and create/update user profile.
 */
function user_profile_manager_process_submission(EntityInterface $submission) {
  $current_user = \Drupal::currentUser();
  
  \Drupal::logger('user_profile_manager')->info('Processing submission @sid for user @uid', [
    '@sid' => $submission->id(),
    '@uid' => $current_user->id(),
  ]);
  
  // Skip if anonymous
  if ($current_user->isAnonymous()) {
    \Drupal::logger('user_profile_manager')->warning('Skipping submission @sid - user is anonymous', [
      '@sid' => $submission->id(),
    ]);
    return;
  }

  $user = \Drupal\user\Entity\User::load($current_user->id());
  if (!$user) {
    \Drupal::logger('user_profile_manager')->error('Could not load user @uid', [
      '@uid' => $current_user->id(),
    ]);
    return;
  }

  $data = $submission->getData();
  $form_id = $submission->getFormId();
  
  \Drupal::logger('user_profile_manager')->info('Submission data: @data', [
    '@data' => print_r($data, TRUE),
  ]);
  
  // Get or create profile
  $profile_storage = \Drupal::entityTypeManager()->getStorage('profile');
  
  $profiles = $profile_storage->loadByProperties([
    'uid' => $user->id(),
    'type' => 'user_submissions',
  ]);
  
  if (empty($profiles)) {
    // Create new profile
    $profile = $profile_storage->create([
      'type' => 'user_submissions',
      'uid' => $user->id(),
    ]);
  }
  else {
    // Use existing profile
    $profile = reset($profiles);
  }
  
  // Get existing submissions data
  $existing_data = $profile->hasField('field_submissions') ? 
    json_decode($profile->get('field_submissions')->value ?? '[]', TRUE) : [];
  
  if (!is_array($existing_data)) {
    $existing_data = [];
  }
  
  // Add new submission
  $existing_data[] = [
    'webform_id' => $form_id,
    'submission_id' => $submission->id(),
    'timestamp' => $submission->getCreatedTime(),
    'email' => $submission->getEmail(),
    'data' => $data,
  ];
  
  // Update profile
  if ($profile->hasField('field_submissions')) {
    $profile->set('field_submissions', json_encode($existing_data));
  }
  
  // Update user info fields if they exist in the submission data
  $form_data = $data[0] ?? $data;
  
  if ($profile->hasField('field_first_name') && isset($form_data['nome'])) {
    $profile->set('field_first_name', $form_data['nome']);
  }
  if ($profile->hasField('field_last_name') && isset($form_data['apelido'])) {
    $profile->set('field_last_name', $form_data['apelido']);
  }
  if ($profile->hasField('field_phone') && isset($form_data['telefone'])) {
    $profile->set('field_phone', $form_data['telefone']);
  }
  if ($profile->hasField('field_company') && isset($form_data['empresa'])) {
    $profile->set('field_company', $form_data['empresa']);
  }
  
  $profile->save();
  
  \Drupal::logger('user_profile_manager')->info('Profile updated for user @uid with submission @sid', [
    '@uid' => $user->id(),
    '@sid' => $submission->id(),
  ]);
}

/**
 * Implements hook_menu_local_tasks_alter().
 * 
 * Remove the "User Submissions Profile" tab from user pages.
 */
function user_profile_manager_menu_local_tasks_alter(&$data, $route_name) {
  // Remove the user_submissions profile tab
  if (isset($data['tabs'][0])) {
    foreach ($data['tabs'][0] as $key => $tab) {
      // Check if this is the user_submissions profile tab
      if (isset($tab['#link']['url']) && $tab['#link']['url']->isRouted()) {
        $route_params = $tab['#link']['url']->getRouteParameters();
        if (isset($route_params['profile_type']) && $route_params['profile_type'] === 'user_submissions') {
          unset($data['tabs'][0][$key]);
        }
      }
    }
  }
}
